# 消息队列

## 为什么使用消息队列?

- 解耦
    + 用消息隔离两个模块，两个模块之间针对消息接口来编程，耦合度降低
    
- 异步
    + 将消息塞入队列后即可返回处理其他事件

- 削峰
    + 流控
    + 经济考虑，当qps很高时，可以分批处理，不需要一次处理很多消息
    

## 各种消息队列产品的比较

|  特性    | ActiveMq  | RabbitMq  |  RocketMQ    | kafka  |
|  :----:    | :----:      |  :----:     | :----:         |  :----:  | 
| 开发语言   | jave |erlang |jave |scale |
| 吞吐量   | 万级 |万级 |10万级 |10万级 |
| 时效性   | ms |us |ms |ms |
| 可用性   | 高(主从架构) |高(主从架构) |非常高<br>(分布式架构) | 非常高<br>(分布式架构) |
| 功能特性 | 成熟的产品，在很多公司得到应用;有较多的文档;各种协议支持较好 |基于erlang开发，所以并发能力很强，性能及其好，延时很低;管理界面较丰富 |MQ功能比较完备，扩展性佳 |只支持主要的MQ功能，像一些消息查询，消息回溯等功能没有提供，毕竟是为大数据准备的，在大数据领域应用广 |

- ActiveMQ, 早期使用的比较多，没经过大规模吞吐量场景的验证，社区也不是很活跃，但是现在确实大家用的不对了 ，不推荐。
- RabbitMQ, 开发语言erlang阻止了大量的java工程师去深入研究和掌控它，对公司而言，几乎处于不可控的状态，但是RabbitMQ是开源的，比较稳定的支持，活跃度也高，如不考虑二次开发，<font color=Red>追求性能和稳定性，推荐使用</font>。
- RocketMQ, 开发语言是Java，在阿里内部经受过高并发业务的考验，<font color=Red>稳定性和性能均不错，考虑后期可能二次开发，推荐使用</font>。
- Kafka, 大数据领域的实时计算、日志采集等场景，用Kafka是业内标准的，社区活跃度很高，推荐使用。<font color=Red>大数据领域日志采集等业务推荐使用</font>。

## 消息队列的优点和缺点

- 缺点
    + 系统可用性降低<br>
        一旦MQ宕机，就会对业务造成影响
    + 系统复杂度提高
        1. 消息丢失怎么办？
            持久化存储到磁盘
        2. 重复消息怎么处理？
            添加全局唯一MsgID
        3. 如何保证消息传递的顺序性？
            队列保证
    + 一致性问题<br>
        可通过分布式事务解决，分区，相同key的msg放入同一分区来操作，一个分区只能被一个消费者获取

## 如何保证消息队列的高可用, 避免消息堆积
1. 提高消费者消费速率
2. 集群，消费者批量获取消息，减少网络传输次数

## MQ如何保证消息不丢失
1. MQ服务器端
    消息持久化到硬盘
2. 生产者
    消息确认机制
    必须确认消息在MQ端成功持久化后，才人为确认投递成功
3. 消费者
    必须确认消息消费成功

## MQ 如何保证消息幂等问题
幂等:就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用

1. 消费者获取消息，如果消费消息失败， mq 服务器则会间隔的形式实现重试策略；
2. 重试过程中，需要保证业务幂等性问题，保证业务不能够重复执行。
3. 我们可以通过全局的消息id，提前查询如果该业务逻辑已经执行过，则不会重复执行。
4. 我们也需要在数据库的db 层面需要保证幂等性问题，唯一主键约束、乐观锁等。

>[消息队列](https://www.zhihu.com/question/54152397?sort=created)
